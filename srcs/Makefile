# Makefile para Inception - manejo de imÃ¡genes locales y contenedores

COMPOSE = docker-compose
IMAGES_DIR = ./images

# Nombres de imÃ¡genes locales
PHP_IMAGE = my_php
MARIADB_IMAGE = my_mariadb
NGINX_IMAGE = my_nginx

# ---------------------------
# Regla principal: limpiar + build + up
all: clean load-or-build-images
	@echo "ğŸŸ¢ Levantando contenedores..."
	@$(COMPOSE) up -d --no-build

# ---------------------------
# Cargar o construir imÃ¡genes
load-or-build-images: $(IMAGES_DIR)
	@echo "ğŸŸ¢ Procesando imÃ¡genes locales..."
	@$(call load_or_build,$(PHP_IMAGE),./requirements/my_php)
	@$(call load_or_build,$(MARIADB_IMAGE),./requirements/my_mariadb)
	@$(call load_or_build,$(NGINX_IMAGE),./requirements/my_nginx)

define load_or_build
	@mkdir -p $(IMAGES_DIR)
	if [ -f $(IMAGES_DIR)/$1.tar ]; then \
		echo "	ğŸ“¦ Cargando imagen local $1..."; \
		docker load -i $(IMAGES_DIR)/$1.tar; \
	else \
		echo "	âœ¨ Construyendo imagen $1..."; \
		docker build --no-cache -t $1 $2 && \
		( echo "ğŸ’¾ Guardando imagen $1 en $(IMAGES_DIR)/$1.tar"; \
		  docker save -o $(IMAGES_DIR)/$1.tar $1 ); \
	fi
endef

# ---------------------------
# Limpieza parcial (contenedores, volÃºmenes, redes)
clean:
	@echo "ğŸŸ¢ Limpiando imÃ¡genes locales (imÃ¡genes guardadas intactas)..."
	-@docker rmi -f $$(docker images -q) 2>/dev/null || echo "	âš ï¸ No hay imÃ¡genes para eliminar."
	@echo "ğŸŸ¢ Limpiando contenedores (imÃ¡genes guardadas intactas)..."
	-@docker stop $$(docker ps -aq) 2>/dev/null || echo "	âš ï¸ No hay contenedores ejecutÃ¡ndose."
	-@docker rm -f $$(docker ps -aq) 2>/dev/null || echo "	âš ï¸ No hay contenedores para eliminar."
	@echo "ğŸŸ¢ Limpiando volÃºmenes (imÃ¡genes guardadas intactas)..."
	-@docker volume rm $$(docker volume ls -q) 2>/dev/null || echo "	âš ï¸ No hay volÃºmenes para eliminar."
	@echo "ğŸŸ¢ Limpiando redes (imÃ¡genes guardadas intactas)..."
	-@docker network rm $$(docker network ls -q | grep -vE "bridge|host|none") 2>/dev/null || echo "	âš ï¸ No hay redes personalizadas."

# ---------------------------
# Limpieza total
fclean: clean
	@echo "ğŸ›‘ Eliminando absolutamente todo (incluyendo imÃ¡genes locales)..."
	-@docker rmi -f $$(docker images -q) 2>/dev/null || echo "	âš ï¸ No hay imÃ¡genes locales para eliminar."
	-@rm -rf $(IMAGES_DIR) || echo "	âš ï¸ No hay images guardadas para eliminar."
	-@docker system prune -af --volumes

up:
	@echo "ğŸŸ¢ Levantando contenedores..."
	@$(COMPOSE) up -d

# ---------------------------
# Bajar contenedores
down:
	@echo "ğŸŸ¢ Apagando contenedores..."
	@$(COMPOSE) down

# ---------------------------
# Rehacer todo desde cero
re: fclean all

# ---------------------------
# Refresh: limpiar contenedores/volÃºmenes pero mantener imÃ¡genes
refresh: clean load-or-build-images up

.PHONY: all clean fclean up down re load-or-build-images refresh images
